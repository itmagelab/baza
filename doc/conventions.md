# Соглашения по разработке

> Правила кодирования для проекта Baza - менеджера паролей.
> Основано на [техническом видении](vision.md) и [плане задач](tasklist.md).

## Обязательные правила

### Коммиты

- **ОБЯЗАТЕЛЬНО** писать коммиты только на английском языке
- **ОБЯЗАТЕЛЬНО** использовать стандартный формат commit message
- **ОБЯЗАТЕЛЬНО** описывать изменения кратко и информативно
- **ЗАПРЕЩЕНО** использовать русский язык в коммитах

### Безопасность кода

- **ЗАПРЕЩЕНО** использовать `unwrap()` и `expect()` без крайней необходимости (lint: `#![deny(clippy::unwrap_used)]`)
- **ОБЯЗАТЕЛЬНО** обрабатывать ошибки через `exn::Result<T>`
- **ОБЯЗАТЕЛЬНО** использовать `?` оператор для пробрасывания ошибок
- **ОБЯЗАТЕЛЬНО** использовать `or_raise` для добавления контекста к ошибкам
- **ОБЯЗАТЕЛЬНО** логировать ошибки через `tracing`
- **ОБЯЗАТЕЛЬНО** не логировать чувствительные данные (пароли, ключи)
- **ОБЯЗАТЕЛЬНО** использовать безопасные криптографические алгоритмы (AES-256-GCM, SHA-256)
- **ОБЯЗАТЕЛЬНО** очищать память от чувствительных данных после использования

### Архитектурные ограничения

- **ЗАПРЕЩЕНО** прямое обращение к файловой системе минуя модули `storage`
- **ЗАПРЕЩЕНО** хардкод путей - использовать только через `Config`
- **ОБЯЗАТЕЛЬНО** использовать модуль `storage` для всех операций с данными
- **ОБЯЗАТЕЛЬНО** следовать существующей архитектуре проекта без отклонений
- **ЗАПРЕЩЕНО** вводить новые архитектурные паттерны без согласования
- **ОБЯЗАТЕЛЬНО** реализовывать защиту от атак по времени (timing attacks)

### Типобезопасность

- **ОБЯЗАТЕЛЬНО** использовать доменные типы (`BoxName`, `BundleName`, а не строки)
- **ЗАПРЕЩЕНО** использовать `String` для путей без валидации
- **ОБЯЗАТЕЛЬНО** валидация данных на границах модулей
- **ЗАПРЕЩЕНО** `Any` типы и dynamic dispatch без веских причин

## Модульная структура

### Размещение кода

- `crates/baza-core` - бизнес-логика, шифрование, работа с данными
- `crates/baza` - CLI интерфейс, парсинг аргументов
- `crates/baza-core/src/storage.rs` - работа с хранилищем (Redb, GitFS)
- `crates/baza-core/src/container.rs` - работа с контейнерами данных
- `crates/baza-core/src/box.rs` - работа с боксами (логические контейнеры)
- `crates/baza-core/src/bundle.rs` - работа с бандлами (группы данных)

### CLI интерфейс

- **ОБЯЗАТЕЛЬНО** использовать `clap` для парсинга аргументов командной строки
- **РАЗРЕШЕНО** человеко-читаемый текстовый вывод с цветовой подсветкой
- **ОБЯЗАТЕЛЬНО** использовать `colored` для цветового выделения важной информации
- **ОБЯЗАТЕЛЬНО** использовать `tracing` для детального логирования при необходимости
- **ОБЯЗАТЕЛЬНО** поддерживать интерактивный ввод паролей
- `crates/baza/src/main.rs` - точка входа CLI приложения
- `crates/baza/src/bundle.rs` - CLI команды для работы с бандлами
- `crates/baza/src/password.rs` - функциональность генерации и управления паролями

### Зависимости между модулями

- **ЗАПРЕЩЕНО** циклические зависимости между крейтами
- **ОБЯЗАТЕЛЬНО** `baza-core` должен быть независимым от `baza`
- **ЗАПРЕЩЕНО** прямой импорт CLI кода в core-логику

## Именование

### Файлы и модули

- snake_case для файлов и модулей
- Один основной тип на файл
- **ЗАПРЕЩЕНО** создание `mod.rs` для новых модулей

### Переменные и функции

- snake_case для функций и переменных
- Глаголы для функций (`create_box`, `unlock_vault`, не `box_create`)
- Существительные для переменных (`box_name`, `passphrase`, не `get_box_name`)

### Типы и трейты

- PascalCase для структур и энумов
- Трейты с суффиксом назначения (`StorageBackend`, не `Backend`)
- Энумы с контекстным префиксом (`StorageType`, не `Type`)

## Обработка ошибок

### Типы ошибок

- **ОБЯЗАТЕЛЬНО** использовать библиотеку `exn` для работы с ошибками
- **ОБЯЗАТЕЛЬНО** использовать `or_raise` для добавления контекста к ошибкам (требует `use exn::ResultExt`)
- **ОБЯЗАТЕЛЬНО** использовать `BazaR<T>` (alias для `exn::Result<T>`) для возврата результатов
- **ОБЯЗАТЕЛЬНО** использовать доменные типы ошибок из `crate::error::Error` для передачи смысла ошибки
- **ЗАПРЕЩЕНО** использовать `anyhow` в новом коде

### Примеры обработки ошибок

```rust
// ✅ Правильно - создание ошибки через Exn::new
if box_name.is_empty() {
    return Err(exn::Exn::new(crate::error::Error::Message("Box name cannot be empty".into())));
}

// ✅ Правильно - добавление контекста через or_raise
let config = Config::init()
    .or_raise(|| crate::error::Error::Message("Failed to initialize configuration".into()))?;

// ❌ Неправильно - использование unwrap без обработки
// let data = fs::read("file.txt").unwrap();

// ✅ Правильно - использование ? оператора с or_raise
let data = fs::read("file.txt")
    .or_raise(|| crate::error::Error::Message("Failed to read file".into()))?;
```

### Логирование

- `tracing::error!` для критических ошибок (сбой шифрования, потеря данных)
- `tracing::warn!` для неожиданных ситуаций (отсутствие конфигурации, устаревший формат)
- `tracing::info!` для важных операций (инициализация, синхронизация)
- `tracing::debug!` для детальной диагностики (внутренние операции)

## Асинхронный код

### Async/await

- **ОБЯЗАТЕЛЬНО** использовать async/await для операций I/O при необходимости
- **ЗАПРЕЩЕНО** блокирующие вызовы в async функциях
- **ОБЯЗАТЕЛЬНО** `Send + Sync` для типов в async контексте

## Тестирование

### Unit тесты

- **ОБЯЗАТЕЛЬНО** тесты для всей бизнес-логики в `baza-core`
- **ОБЯЗАТЕЛЬНО** проверка корректности шифрования/дешифрования
- **ЗАПРЕЩЕНО** тесты, зависящие от внешних сервисов без mock'ов

### Интеграционные тесты

- **ОБЯЗАТЕЛЬНО** тесты для критических user flow (инициализация, разблокировка)
- **ОБЯЗАТЕЛЬНО** cleanup после каждого теста
- **ОБЯЗАТЕЛЬНО** тесты для синхронизации данных

## Конфигурация

### Файлы конфигурации

- **ОБЯЗАТЕЛЬНО** хранить конфигурацию в `~/.config/baza/baza.toml`
- **ОБЯЗАТЕЛЬНО** создавать конфигурацию по умолчанию при первом запуске
- **ОБЯЗАТЕЛЬНО** использовать TOML формат для конфигурации
- **ОБЯЗАТЕЛЬНО** валидировать конфигурацию при загрузке
- **ОБЯЗАТЕЛЬНО** поддерживать миграцию конфигурационных файлов между версиями

## Безопасность

### Данные

- **ЗАПРЕЩЕНО** хранение паролей в открытом виде
- **ОБЯЗАТЕЛЬНО** шифрование всех данных с помощью AES-256-GCM
- **ОБЯЗАТЕЛЬНО** хранение ключа шифрования в защищенном месте
- **ОБЯЗАТЕЛЬНО** использование криптографически стойких алгоритмов
- **ОБЯЗАТЕЛЬНО** очищать память от чувствительных данных после использования

### Операции

- **ОБЯЗАТЕЛЬНО** проверять состояние разблокировки перед операциями с данными
- **ОБЯЗАТЕЛЬНО** очищать временные файлы после использования
- **ОБЯЗАТЕЛЬНО** использовать безопасные методы генерации случайных данных
- **ОБЯЗАТЕЛЬНО** реализовывать защиту от атак по времени (timing attacks)

## Основные операции разработки

### Запуск

- **Запуск CLI:** `RUST_LOG=debug cargo run --bin baza --manifest-path crates/baza/Cargo.toml`

```bash
RUST_LOG=debug cargo run --bin baza
```

- **Запуск команд:** `RUST_LOG=debug cargo run --manifest-path crates/baza/Cargo.toml -- [command]`
Примеры команд:

```bash
RUST_LOG=debug cargo run --manifest-path crates/baza/Cargo.toml -- init
RUST_LOG=debug cargo run --manifest-path crates/baza/Cargo.toml -- box create mybox
RUST_LOG=debug cargo run --manifest-path crates/baza/Cargo.toml -- sync
```

### Разработка и тестирование

- **Сборка проекта:** `cargo build --workspace`
- **Проверка кода:** `cargo check --workspace`
- **Запуск тестов:** `cargo test --workspace`
- **Форматирование:** `cargo fmt --workspace`
- **Линтинг:** `cargo clippy --workspace`
- **Документация:** `cargo doc --workspace --no-deps --open --lib --bins`

### Работа с хранилищем

- **Инициализация хранилища:** `baza init`
- **Разблокировка хранилища:** `baza unlock`
- **Блокировка хранилища:** `baza lock`
- **Синхронизация данных:** `baza sync`

### Инициализация и настройка

- **Инициализация хранилища:** `baza init`
- **Генерация пароля:** `baza generate`
- **Создание конфигурации:** `baza config generate`

### Отладка

- **Просмотр логов:** `RUST_LOG=debug cargo run --manifest-path crates/baza/Cargo.toml -- [command]`
- **Просмотр структуры хранилища:** `find ~/.baza -type f -not -path "*/\\.git/*"`
- **Проверка состояния синхронизации:** `cd ~/.baza && git status --porcelain`
- **Очистка временных файлов:** `RUST_LOG=debug cargo run --manifest-path crates/baza/Cargo.toml -- cleanup`
